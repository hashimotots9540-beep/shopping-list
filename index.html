<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Ë≤∑„ÅÑÁâ©„É°„É¢</title>
    
    <!-- PWA Settings -->
    <meta name="apple-mobile-web-app-title" content="Ë≤∑„ÅÑÁâ©„É°„É¢">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="mobile-web-app-capable" content="yes">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase SDK (Compatibility Mode) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <!-- React -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body {
            background-color: #f9fafb;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }
        .safe-top { padding-top: env(safe-area-inset-top, 20px); }
        .safe-bottom { padding-bottom: env(safe-area-inset-bottom, 20px); }
        .item-enter { animation: slideIn 0.3s ease-out forwards; }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        /* „Çπ„ÉØ„Ç§„Éó‰∏≠„ÅÆ„Ç¨„Çø„Å§„ÅçÈò≤Ê≠¢ */
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- FirebaseË®≠ÂÆö ---
        // GeminiÁí∞Â¢É„ÅÆÂ§âÊï∞„ÇíÂèñÂæó„ÄÅ„Åæ„Åü„ÅØÁ©∫„ÅÆ„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„Çí‰ª£ÂÖ•
        const firebaseConfig = JSON.parse(window.__firebase_config || '{}');
        const appId = window.__app_id || 'shopping-app-v1';

        // FirebaseÂàùÊúüÂåñÔºà‰∏ÄÂ∫¶„Å†„ÅëÂÆüË°åÔºâ
        if (firebaseConfig.apiKey && !firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }

        const App = () => {
            const [items, setItems] = useState(() => JSON.parse(localStorage.getItem('shop_cache') || '[]'));
            const [inputValue, setInputValue] = useState('');
            const [groupId, setGroupId] = useState(() => localStorage.getItem('shop_group') || 'ÂÆ∂Êóè');
            const [isSettingsOpen, setIsSettingsOpen] = useState(false);
            const [activeTab, setActiveTab] = useState('list'); // 'list' or 'history'
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                if (!firebaseConfig.apiKey) return;

                // ÂåøÂêç„É≠„Ç∞„Ç§„É≥„Åó„Å¶Firestore„Å´Êé•Á∂ö
                firebase.auth().signInAnonymously().then(() => {
                    const db = firebase.firestore();
                    const collectionPath = `artifacts/${appId}/public/data/items-${groupId}`;
                    
                    const unsubscribe = db.collection(collectionPath)
                        .orderBy('createdAt', 'desc')
                        .onSnapshot(snapshot => {
                            const newItems = snapshot.docs.map(doc => ({
                                id: doc.id,
                                ...doc.data()
                            }));
                            setItems(newItems);
                            localStorage.setItem('shop_cache', JSON.stringify(newItems));
                            setLoading(false);
                        }, err => {
                            console.error("Firestore Error:", err);
                            setLoading(false);
                        });

                    return () => unsubscribe();
                });
            }, [groupId]);

            const addItem = async (e) => {
                e.preventDefault();
                if (!inputValue.trim()) return;
                const name = inputValue.trim();
                setInputValue('');
                
                try {
                    await firebase.firestore().collection(`artifacts/${appId}/public/data/items-${groupId}`).add({
                        name,
                        completed: false,
                        archived: false,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                } catch (err) { alert("ËøΩÂä†„Å´Â§±Êïó„Åó„Åæ„Åó„Åü"); }
            };

            const toggleItem = async (item) => {
                await firebase.firestore().collection(`artifacts/${appId}/public/data/items-${groupId}`).doc(item.id).update({
                    completed: !item.completed
                });
            };

            const archiveItem = async (id) => {
                await firebase.firestore().collection(`artifacts/${appId}/public/data/items-${groupId}`).doc(id).update({
                    archived: true
                });
            };

            const restoreItem = async (id) => {
                await firebase.firestore().collection(`artifacts/${appId}/public/data/items-${groupId}`).doc(id).update({
                    archived: false,
                    completed: false
                });
            };

            const deleteItem = async (id) => {
                if(confirm("ÂÆåÂÖ®„Å´ÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü")) {
                    await firebase.firestore().collection(`artifacts/${appId}/public/data/items-${groupId}`).doc(id).delete();
                }
            };

            const currentItems = items.filter(i => !i.archived);
            const historyItems = items.filter(i => i.archived);

            return (
                <div className="flex flex-col h-screen max-w-md mx-auto bg-gray-50 overflow-hidden">
                    {/* Header */}
                    <header className="bg-white border-b border-gray-100 px-6 py-4 safe-top flex justify-between items-center shrink-0">
                        <div>
                            <h1 className="text-xl font-black text-gray-800 tracking-tight flex items-center gap-2">
                                <span className="text-2xl">üõí</span> {groupId}„ÅÆ„É°„É¢
                            </h1>
                        </div>
                        <button onClick={() => setIsSettingsOpen(true)} className="w-10 h-10 flex items-center justify-center bg-gray-100 rounded-full text-gray-500">
                            ‚öôÔ∏è
                        </button>
                    </header>

                    {/* Main List */}
                    <main className="flex-1 overflow-y-auto px-4 py-4 no-scrollbar">
                        {activeTab === 'list' ? (
                            currentItems.length === 0 ? (
                                <div className="flex flex-col items-center justify-center h-64 text-gray-300">
                                    <span className="text-64">üìù</span>
                                    <p className="mt-4 font-bold">„É™„Çπ„Éà„ÅØÁ©∫„Å£„ÅΩ„Åß„Åô</p>
                                </div>
                            ) : (
                                currentItems.map(item => (
                                    <div key={item.id} className="bg-white mb-3 p-4 rounded-2xl shadow-sm border border-gray-100 flex items-center gap-4 item-enter transition-all active:scale-95"
                                         onClick={() => toggleItem(item)}>
                                        <div className={`w-7 h-7 rounded-full border-2 flex items-center justify-center transition-all ${item.completed ? 'bg-green-500 border-green-500 text-white' : 'border-gray-200'}`}>
                                            {item.completed && "‚úì"}
                                        </div>
                                        <span className={`flex-1 text-lg font-medium transition-all ${item.completed ? 'text-gray-300 line-through' : 'text-gray-700'}`}>
                                            {item.name}
                                        </span>
                                        {item.completed && (
                                            <button onClick={(e) => { e.stopPropagation(); archiveItem(item.id); }} className="text-xs bg-gray-100 text-gray-400 px-3 py-1 rounded-full font-bold">
                                                ÂÆå‰∫Ü
                                            </button>
                                        )}
                                    </div>
                                ))
                            )
                        ) : (
                            historyItems.length === 0 ? (
                                <div className="text-center py-20 text-gray-300 font-bold">Â±•Ê≠¥„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì</div>
                            ) : (
                                historyItems.map(item => (
                                    <div key={item.id} className="bg-gray-100 mb-2 p-4 rounded-xl flex items-center justify-between opacity-60">
                                        <span className="text-gray-500 line-through">{item.name}</span>
                                        <div className="flex gap-2">
                                            <button onClick={() => restoreItem(item.id)} className="bg-white px-3 py-1 rounded-lg text-sm font-bold text-green-600 shadow-sm">Êàª„Åô</button>
                                            <button onClick={() => deleteItem(item.id)} className="text-red-400 px-2">‚úï</button>
                                        </div>
                                    </div>
                                ))
                            )
                        )}
                    </main>

                    {/* Bottom Input Area */}
                    {activeTab === 'list' && (
                        <div className="p-4 bg-white border-t border-gray-100 safe-bottom shadow-2xl">
                            <form onSubmit={addItem} className="flex gap-3">
                                <input 
                                    value={inputValue} 
                                    onChange={e => setInputValue(e.target.value)}
                                    placeholder="‰Ωï„ÇíË≤∑„ÅÜÔºü" 
                                    className="flex-1 bg-gray-100 rounded-2xl px-5 py-4 outline-none focus:ring-2 focus:ring-green-400 text-lg font-medium"
                                />
                                <button type="submit" className="bg-green-500 text-white w-14 h-14 rounded-2xl shadow-lg shadow-green-200 flex items-center justify-center text-3xl font-bold active:scale-90 transition-transform">
                                    +
                                </button>
                            </form>
                        </div>
                    )}

                    {/* Tab Navigation */}
                    <nav className="bg-white border-t border-gray-100 flex justify-around safe-bottom">
                        <button onClick={() => setActiveTab('list')} className={`flex-1 py-4 flex flex-col items-center gap-1 ${activeTab === 'list' ? 'text-green-600' : 'text-gray-400'}`}>
                            <span className="text-2xl">üõí</span>
                            <span className="text-[10px] font-black">„É™„Çπ„Éà</span>
                        </button>
                        <button onClick={() => setActiveTab('history')} className={`flex-1 py-4 flex flex-col items-center gap-1 ${activeTab === 'history' ? 'text-green-600' : 'text-gray-400'}`}>
                            <span className="text-2xl">üïí</span>
                            <span className="text-[10px] font-black">Â±•Ê≠¥</span>
                        </button>
                    </nav>

                    {/* Settings Modal */}
                    {isSettingsOpen && (
                        <div className="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-end sm:items-center justify-center">
                            <div className="bg-white w-full max-w-md rounded-t-3xl sm:rounded-3xl p-8 animate-item">
                                <div className="flex justify-between items-center mb-6">
                                    <h2 className="text-2xl font-black text-gray-800">ÂÆ∂Êóè„Å®ÂêåÊúü„Åô„Çã</h2>
                                    <button onClick={() => setIsSettingsOpen(false)} className="text-gray-300 text-2xl">‚úï</button>
                                </div>
                                <p className="text-gray-400 mb-6 font-medium">Âêå„Åò„ÄåÂêàË®ÄËëâ„Äç„ÇíÂÖ•„Çå„Çã„Å®„ÄÅÂÆ∂Êóè„Å®„É™„Çπ„Éà„ÇíÂÖ±Êúâ„Åß„Åç„Åæ„Åô„ÄÇ</p>
                                <input 
                                    className="w-full bg-gray-50 border-2 border-gray-100 rounded-2xl px-5 py-4 mb-8 outline-none focus:border-green-500 text-xl font-bold"
                                    defaultValue={groupId}
                                    onBlur={(e) => {
                                        const val = e.target.value.trim() || 'ÂÆ∂Êóè';
                                        setGroupId(val);
                                        localStorage.setItem('shop_group', val);
                                    }}
                                />
                                <button onClick={() => setIsSettingsOpen(false)} className="w-full bg-green-500 text-white py-5 rounded-2xl font-black text-lg shadow-lg shadow-green-200 active:scale-95 transition-all">
                                    Ë®≠ÂÆö„Çí‰øùÂ≠ò
                                </button>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
