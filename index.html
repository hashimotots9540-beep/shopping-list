<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>è²·ã„ç‰©ãƒ¡ãƒ¢</title>
    
    <!-- PWA Settings -->
    <meta name="apple-mobile-web-app-title" content="è²·ã„ç‰©ãƒ¡ãƒ¢">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="mobile-web-app-capable" content="yes">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body { background-color: #f9fafb; font-family: -apple-system, sans-serif; -webkit-tap-highlight-color: transparent; }
        .safe-top { padding-top: env(safe-area-inset-top, 20px); }
        .safe-bottom { padding-bottom: env(safe-area-inset-bottom, 20px); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // --- é‡è¦ï¼šFirebaseè¨­å®š ---
        // ã“ã“ã«ç›´æ¥è¨­å®šã‚’æ›¸ãè¾¼ã¿ã¾ã™ï¼ˆGeminiç’°å¢ƒã‹ã‚‰è‡ªå‹•å–å¾—ã‚’è©¦ã¿ã¾ã™ãŒã€å¤±æ•—æ™‚ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’å¼·åŒ–ï¼‰
        const configStr = window.__firebase_config || localStorage.getItem('fb_config_backup');
        const firebaseConfig = configStr ? JSON.parse(configStr) : null;
        const appId = window.__app_id || localStorage.getItem('fb_app_id_backup') || 'shopping-app-v1';

        // è¨­å®šã‚’ä¿å­˜ã—ã¦ãŠãï¼ˆæ¬¡å›èµ·å‹•æ™‚ã®ãŸã‚ï¼‰
        if (window.__firebase_config) localStorage.setItem('fb_config_backup', window.__firebase_config);
        if (window.__app_id) localStorage.setItem('fb_app_id_backup', window.__app_id);

        if (firebaseConfig && !firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }

        const App = () => {
            const [items, setItems] = useState([]);
            const [inputValue, setInputValue] = useState('');
            const [groupId, setGroupId] = useState(() => localStorage.getItem('shop_group') || 'å®¶æ—');
            const [isSettingsOpen, setIsSettingsOpen] = useState(false);
            const [tab, setTab] = useState('list');

            useEffect(() => {
                if (!firebaseConfig) {
                    console.error("Firebase config is missing.");
                    return;
                }

                firebase.auth().signInAnonymously().then(() => {
                    const db = firebase.firestore();
                    const path = `artifacts/${appId}/public/data/items-${groupId}`;
                    
                    return db.collection(path).orderBy('createdAt', 'desc').onSnapshot(ss => {
                        setItems(ss.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                    });
                }).catch(err => console.error("Auth error:", err));
            }, [groupId]);

            const addItem = async (e) => {
                e.preventDefault();
                if (!inputValue.trim() || !firebaseConfig) return;
                const name = inputValue.trim();
                setInputValue('');
                
                try {
                    await firebase.firestore().collection(`artifacts/${appId}/public/data/items-${groupId}`).add({
                        name, completed: false, archived: false, createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                } catch (err) {
                    alert("è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸã€‚è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
                }
            };

            const toggle = async (item) => {
                await firebase.firestore().collection(`artifacts/${appId}/public/data/items-${groupId}`).doc(item.id).update({
                    completed: !item.completed
                });
            };

            const archive = async (id) => {
                await firebase.firestore().collection(`artifacts/${appId}/public/data/items-${groupId}`).doc(id).update({ archived: true });
            };

            const activeItems = items.filter(i => !i.archived);
            const historyItems = items.filter(i => i.archived);

            if (!firebaseConfig) {
                return (
                    <div className="p-10 text-center">
                        <p className="text-red-500 font-bold">è¨­å®šæƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</p>
                        <p className="text-sm text-gray-500 mt-2">ä¸€åº¦Geminiã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”»é¢ã‚’é–‹ã„ã¦ã‹ã‚‰ã€å†åº¦ã“ã¡ã‚‰ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ãã ã•ã„ã€‚</p>
                    </div>
                );
            }

            return (
                <div className="flex flex-col h-screen max-w-md mx-auto bg-white overflow-hidden">
                    <header className="bg-white border-b px-6 py-4 safe-top flex justify-between items-center shrink-0">
                        <h1 className="text-xl font-black text-gray-800 tracking-tight">ğŸ›’ {groupId}ã®ãƒ¡ãƒ¢</h1>
                        <button onClick={() => setIsSettingsOpen(true)} className="w-10 h-10 bg-gray-100 rounded-full flex items-center justify-center">âš™ï¸</button>
                    </header>

                    <main className="flex-1 overflow-y-auto px-4 py-4">
                        {tab === 'list' ? (
                            activeItems.map(item => (
                                <div key={item.id} className="bg-white mb-3 p-4 rounded-2xl shadow-sm border flex items-center gap-4" onClick={() => toggle(item)}>
                                    <div className={`w-6 h-6 rounded-full border-2 flex items-center justify-center ${item.completed ? 'bg-green-500 border-green-500 text-white' : 'border-gray-200'}`}>
                                        {item.completed && "âœ“"}
                                    </div>
                                    <span className={`flex-1 text-lg ${item.completed ? 'text-gray-300 line-through' : 'text-gray-700'}`}>{item.name}</span>
                                    {item.completed && <button onClick={(e) => { e.stopPropagation(); archive(item.id); }} className="text-xs bg-gray-100 px-2 py-1 rounded">å®Œäº†</button>}
                                </div>
                            ))
                        ) : (
                            historyItems.map(item => <div key={item.id} className="p-3 border-b text-gray-400 line-through">{item.name}</div>)
                        )}
                    </main>

                    <div className="p-4 bg-white border-t safe-bottom">
                        <form onSubmit={addItem} className="flex gap-2">
                            <input value={inputValue} onChange={e => setInputValue(e.target.value)} placeholder="ä½•ã‚’è²·ã†ï¼Ÿ" className="flex-1 bg-gray-100 rounded-xl px-4 py-3 outline-none" />
                            <button type="submit" className="bg-green-500 text-white px-6 py-3 rounded-xl font-bold">+</button>
                        </form>
                    </div>

                    <nav className="flex border-t bg-white safe-bottom">
                        <button onClick={() => setTab('list')} className={`flex-1 py-4 text-center ${tab === 'list' ? 'text-green-600 font-bold' : 'text-gray-400'}`}>ãƒªã‚¹ãƒˆ</button>
                        <button onClick={() => setTab('history')} className={`flex-1 py-4 text-center ${tab === 'history' ? 'text-green-600 font-bold' : 'text-gray-400'}`}>å±¥æ­´</button>
                    </nav>

                    {isSettingsOpen && (
                        <div className="fixed inset-0 bg-black/60 flex items-center justify-center p-6 z-50">
                            <div className="bg-white w-full rounded-3xl p-8 shadow-2xl">
                                <h2 className="text-2xl font-bold mb-4">åˆè¨€è‘‰</h2>
                                <input className="w-full border-2 rounded-2xl p-4 mb-6 outline-none focus:border-green-500 text-xl font-bold" defaultValue={groupId} onBlur={e => { setGroupId(e.target.value); localStorage.setItem('shop_group', e.target.value); }} />
                                <button onClick={() => setIsSettingsOpen(false)} className="w-full bg-green-500 text-white py-4 rounded-2xl font-bold">å®Œäº†</button>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
